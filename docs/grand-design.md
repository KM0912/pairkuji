# pairkuji グランドデザイン

本書は、`docs/personas.md` のペルソナに基づき、pairkuji の製品ビジョン、原則、体験設計、機能範囲、技術・運用要件を統合した指針（Grand Design）です。意思決定の拠り所として、MVP〜拡張の優先度と整合性を保ちます。

---

## 1. ビジョン / ゴール

- ビジョン: 公平・効率・納得のダブルス練習運営を 1 タップで。
- 成果ゴール:
  - 公平性: 試合回数・休憩回数の偏り最小化、同ペア/同対戦の連発回避
  - スピード: ラウンド生成 1 秒以内、現場での迷いゼロの操作
  - 納得感: 進行・掲示が見やすく、説明可能な公平性（履歴考慮）

---

## 2. 製品原則（プロダクト・ピラー）

1) 公平性が伝わる結果
- 最近のペア/対戦履歴を重みづけ反映、結果が直観的に「公平」と感じられる

2) 現場スピード最優先
- 片手操作・1タップ生成・Undo/Redo、UIは思考停止で運用できること

3) 変動に強い進行
- 途中参加・離脱・体調配慮に即応、再生成で安定した品質を保つ

4) 視認性とアクセシビリティ
- 体育館で見やすい大きさ/コントラスト、フルスクリーン掲示、読み上げ配慮

5) オフライン・壊れない
- IndexedDB 自動保存、PWA キャッシュ、復帰の確実さ

---

## 3. 対象ユーザーと価値（要約）

- A 主催者・進行役: フェアな自動生成と高速進行、連続休憩回避
- B 受付・サブ進行: 参加/休憩切替の即時反映、誤操作防止
- C 一般参加者: 多様な相手と試合、待機の納得感、見やすい掲示
- D 顧問/コーチ: 未対戦/未同ペアの消化、学習効果と効率の両立

詳細は `docs/personas.md` を参照。

---

## 4. 体験設計（ユーザージャーニー）

- 初回準備（受付/B）: メンバー登録 → アクティブ化
- 当日開始（主催/A）: コート数設定 → 参加者選択 → R1 生成/掲示
- ラウンド運用（A/B）: 確定 → 次生成 → 掲示 → 入替/休憩微調整
- 変動対応（A/B）: 途中参加/離脱、連続休憩の是正、再生成の安全性
- 振り返り（D/A）: 組合せの多様性・出場分布の確認、改善方針

---

## 5. 情報設計（IA）

- ルート構成（App Router）
  - `/` トップ（新規開始/前回の続き）
  - `/members` メンバー管理（登録/編集/有効化）
  - `/practice` 練習設定・参加者選択
  - `/practice/round/[n]` ラウンド進行（コートカード、休憩、操作）
- 主要コンポーネント
  - `CourtCard`（入替/休憩操作）、`RestPanel`、`RoundControls`、`MemberManagement`、`HelpModal`
- 表示モード
  - 通常操作モード / フルスクリーン掲示モード（視認性最優先）

---

## 6. 機能範囲とロードマップ

- MVP（受け入れ条件に準拠）
  - 公平性アルゴリズムでのラウンド生成（1 秒以内）
  - 参加/休憩切替、入替、途中参加補正、状態の自動保存
  - PWA（オフライン/再起動復元/ホーム追加）、フルスクリーン掲示
  - 簡易統計（出場/休憩カウント、最近の組合せの重複制御）

- フェーズ2（運用の見える化）
  - 偏りサマリ（分散/レンジ/連続休憩率）と改善ヒントの表示
  - 未対戦/未同ペアの可視化と優先度チューニング UI
  - キオスク表示最適化（自動画面ロック/明暗テーマ/音量少）
  - エクスポート（CSV/画像）と簡易バックアップ

- フェーズ3（高度化と拡張）
  - ルールプリセット（部活/社会人/初心者配慮など）
  - クラウド同期（任意、オフライン単独を維持）
  - 分析ビュー（長期のペア・対戦多様性、参加傾向）

---

## 7. 非機能要件（NFR）

- パフォーマンス: 参加 8〜24 名、2〜6 面で 1 秒以内に生成
- 可用性/復元性: すべての状態変更で `updatedAt`、クラッシュ後も復元
- オフライン: SW によるアプリシェル Cache First、データは IndexedDB
- 安全性/プライバシ: ローカル保存を基本。氏名のみ、追跡なし（同意のない分析不可）
- アクセシビリティ: 大きなタップ領域、コントラスト、キーボード操作配慮

---

## 8. コアアルゴリズム方針（要約）

- ステップ: 休憩者選定 → ペア形成 → コート配置（段階最適化）
- 評価: 出場/休憩の分散・範囲、連続休憩回避、最近のペア/対戦重複に減衰つきペナルティ
- 探索: バックトラック＋制限ランダムで局所最適回避、動的重み調整
- 目的: 「結果が納得できる」公平性と、多様性/安定性/速度のバランス

（詳細は `src/lib/fairnessAlgorithm.ts` と `CLAUDE.md` を参照）

---

## 9. UX / UI ガイドライン

- 操作最小化: 1タップ生成、引き算の UI、よく使う操作は親指届く位置
- 誤操作耐性: Undo/Redo、確定前プレビュー、重要操作に軽い確認
- 視認性: カードレイアウト、行間/フォント大、コントラストの担保
- 掲示: フルスクリーン、コートごとブロック、休憩は区別色
- 状態遷移: 生成→微調整→確定→統計更新→次…のリズムが崩れない

### カラーグランドデザイン（ペルソナ起点）

- 目的: 体育館の強い照明下でも「遠目で判読」「状態の即判別」「誤操作防止」を満たす。
- 方針: 色は意味（セマンティクス）に割り当て、装飾では使わない。色だけに依存せずテキスト/アイコン/形状で補強する。

【推奨パレット（Light 基準）】
- ベース/テキスト
  - 背景 `#FFFFFF`、サーフェス `#F8FAFC`、ボーダー `#E2E8F0`
  - テキスト主 `#0F172A`、副 `#475569`
- プライマリ（主要操作/強調）
  - `--color-primary` `#2563EB`（Blue 600）/ Hover `#1D4ED8` / Focus リング `#60A5FA`
- アクセント（補助強調/選択）
  - `--color-accent` `#06B6D4`（Cyan 500）/ Hover `#0891B2`
- 成功/注意/危険/情報（ステータス）
  - Success: 前景 `#065F46` 背景 `#ECFDF5` ボーダー `#A7F3D0`
  - Warning: 前景 `#92400E` 背景 `#FFFBEB` ボーダー `#FDE68A`
  - Danger: 前景 `#7F1D1D` 背景 `#FEF2F2` ボーダー `#FCA5A5`
  - Info:   前景 `#1E40AF` 背景 `#EEF2FF` ボーダー `#C7D2FE`
- 休憩（ネガティブではない区別色）
  - Rest: 前景 `#0F172A` 背景 `#F1F5F9` ボーダー `#CBD5E1`（温和な無彩色）

【コート識別（最大 6 面想定）】
- Court 1 `#2563EB`、Court 2 `#4F46E5`、Court 3 `#059669`、Court 4 `#0D9488`、Court 5 `#7C3AED`、Court 6 `#0891B2`
- 使い方: カードの「ヘッダー帯/左縁」にのみ使用。白文字/太字/番号バッジで必ず補強。
- 配慮: 色覚多様性に配慮し、色と番号の併用（色のみで識別しない）。

【セマンティック・マッピング】
- CTA（次の組み合わせを生成）: Primary 塗りボタン（白文字）
- 破壊的操作（リセット）: Danger 枠線ボタン（押下時のみ塗り）
- 情報/補足（ヘルプ/ヒント）: Info トーンのトースト/バナー
- 成功通知（確定/保存）: Success トースト（短時間）
- 休憩パネル: Rest トーンの面色＋区別アイコン（ベンチ）

【アクセシビリティ基準】
- 文字コントラスト: 本文/ラベル 7.0:1 以上、ボタンテキスト 4.5:1 以上
- 非文字 UI（アイコン/境界）: 3.0:1 以上を目安
- 色覚多様性: Deuteranopia/Protanopia/Monochrome で識別可能（番号/アイコン/パターン併用）

【実装トークン例（CSS Variables）】
```
:root{
  --bg:#FFFFFF;--surface:#F8FAFC;--elevated:#FFFFFF;--border:#E2E8F0;
  --text:#0F172A;--text-muted:#475569;--focus:#60A5FA;
  --primary:#2563EB;--primary-hover:#1D4ED8;--accent:#06B6D4;
  --success-fg:#065F46;--success-bg:#ECFDF5;--success-bd:#A7F3D0;
  --warn-fg:#92400E;--warn-bg:#FFFBEB;--warn-bd:#FDE68A;
  --danger-fg:#7F1D1D;--danger-bg:#FEF2F2;--danger-bd:#FCA5A5;
  --info-fg:#1E40AF;--info-bg:#EEF2FF;--info-bd:#C7D2FE;
  --rest-fg:#0F172A;--rest-bg:#F1F5F9;--rest-bd:#CBD5E1;
}
```

【使い分けルール】
- 主要操作は常に Primary。二次操作はアウトライン/テキストボタン。
- 危険操作は平常時アウトライン（赤文字/枠）、確認後のみ塗り赤。
- 識別色は 1 画面 6 色以内、Court 色はヘッダー限定で乱用しない。
- 情報密度が高い画面では彩度を抑え、注意/危険のみ色を主張させる。

---

## 10. データ/アーキテクチャ指針

- フロント: Next.js (App Router) + TypeScript、Zustand でストア分割
- データ: Dexie/IndexedDB（`db.ts`）、単一練習モデル、履歴管理は不要（MVP）
- PWA: SW（Workbox 採用予定）、Manifest 設定、オフライン起動
- スキーマ: 破壊的変更はマイグレーション関数を用意、互換維持
- 設計原則: 変更に強いストア（`practiceStore`/`roundStore`/`statsStore`）

---

## 11. メトリクス / フィードバック

- ローカル KPI（画面表示）
  - 出場回数分散/レンジ、連続休憩率、未対戦/未同ペアの消化率
- 品質モニタ
  - 生成時間、UI 応答（100ms 以内）
- 将来の任意オプション
  - 同意ベースの匿名化エクスポート（オフライン前提を崩さない）

---

## 12. リスクとトレードオフ

- 公平性の感じ方の個人差 → プリセット/重みの簡易チューニングで吸収
- ランダム性の説明責任 → 直近履歴と理由の簡易表示（例: 重複回避）
- 途中参加が多い場の安定性 → 連続休憩ペナルティの動的緩和

---

## 13. リリース/運用計画

- 現場ベータ（体育館で 2〜3 回）→ フィードバック反映
- 受け入れ条件の達成確認（`CLAUDE.md` 記載の 6 項目）
- SW 更新ポリシー: メジャー更新は再読み込み誘導、軽微はサイレント
- ドキュメント: 使い方（HelpModal）、ペルソナ、グランドデザインを同期更新

---

## 14. 用語集

- ラウンド: 同時に行う複数コートの試合セット
- 休憩者: そのラウンドで試合に出ない参加者
- ペア/対戦の重複: 直近の同一組合せの再登場（減衰つきペナルティ対象）

---

## 付録: 受け入れ条件（MVP 再掲）

1) 8〜24 名・2〜6 面で運用可能  2) 生成 1 秒以内
3) 再起動で状態復帰            4) 途中参加の休憩偏り是正
5) 連続休憩 2 回以上 5% 以下   6) シンプルな操作フロー

本グランドデザインは、実運用の学びに応じて継続的にアップデートします。
