# 公平性アルゴリズム自動テスト

このディレクトリには、ダブルス練習のペア・試合組み合わせ生成アルゴリズムの公平性を検証するための自動テストが含まれています。

## テスト実行方法

```bash
# 全テストを実行（結果のみ表示）
npm run test:run

# インタラクティブモードでテスト実行
npm run test

# UIでテスト実行・監視
npm run test:ui
```

## テスト項目

### 1. 基本機能テスト

- 最小人数（4人）での組み合わせ生成
- 人数不足時の適切な処理
- 基本的なデータ構造の検証

### 2. 様々なコート数・参加者数での組み合わせ生成

以下のシナリオで組み合わせが正しく生成されることを確認：

- 6人1コート
- 8人2コート  
- 10人2コート
- 12人3コート
- 16人4コート
- 20人5コート
- 24人6コート

各シナリオで、期待されるコート数と参加者数が正しく配分されることを検証。

### 3. 試合数偏り検証

複数ラウンド実行後の試合数分散を測定：

| シナリオ | ラウンド数 | 最大許容分散 |
|---------|-----------|-------------|
| 8人2コート | 20ラウンド | 1.0 |
| 12人3コート | 30ラウンド | 1.5 |
| 16人4コート | 40ラウンド | 2.0 |

**検証項目：**
- 試合数の分散が許容値以下
- 最大試合数と最小試合数の差が5未満
- 完全平等な試合数配分の実現（理想：分散0.00）

### 4. 組み合わせ多様性検証

**ペア多様性：**
- 8人シナリオ：理論上可能な28通り全てのペア組み合わせを生成
- 6人シナリオ：理論上可能な15通り全てのペア組み合わせを生成（高網羅率90%以上）

**試合多様性：**
- 12人3コートで100ラウンド実行時に50種類以上の異なる試合組み合わせを生成

### 5. 連続休憩ペナルティ検証

- 10人2コート20ラウンドシナリオで連続休憩の発生を最小化
- 連続休憩ペナルティがラウンド数の30%以下に収まることを確認

### 6. パフォーマンスベンチマーク

- 20人5コート設定で10回の組み合わせ生成
- 1回あたりの生成時間が1秒以内であることを確認（実測：約0.6ms）

### 7. エッジケース処理

**プレイヤー数がコート数の倍数の場合：**
- 16人4コートで全員が試合参加、休憩者0人

**既存履歴がある場合：**
- 前ラウンド休憩者が次ラウンドで優先的に試合参加
- 統計情報（パートナー履歴、対戦履歴）の正確な記録と活用

### 8. 統計計算検証

- 複数ラウンドからの選手統計の正確な計算
- 試合数、休憩数、連続休憩数の追跡
- パートナー履歴、対戦相手履歴の記録

## テスト結果の例

```
8人2コート: 試合数分散=0.00, 最小=20, 最大=20, 差=0
12人3コート: 試合数分散=0.00, 最小=30, 最大=30, 差=0  
16人4コート: 試合数分散=0.00, 最小=40, 最大=40, 差=0
8人での生成ペア数: 28 / 理論値: 28
6人での生成ペア数: 15 / 理論値: 15
12人での生成試合組み合わせ数: 279
連続休憩ペナルティ合計: 3
平均生成時間: 0.58ms
```

## 推奨されるテスト基準

### 合格基準

1. **試合数公平性**: 分散値が設定値以下、最大差が5試合以内
2. **組み合わせ多様性**: 理論値の80%以上のペア組み合わせを生成
3. **連続休憩制御**: 連続休憩ペナルティがラウンド数の30%以下
4. **パフォーマンス**: 1回の組み合わせ生成が1秒以内
5. **エッジケース対応**: 特殊条件下でもエラーなく動作

### 継続的監視項目

- アルゴリズム変更時の全テスト実行
- パフォーマンス劣化の早期発見
- 新しいシナリオでの検証追加
- 実運用データでの追加検証

## 拡張可能な検証項目

1. **スキルレベル考慮**: 同レベル同士のマッチング検証（将来機能）
2. **コート制約**: 特定コートの使用制限への対応検証
3. **プレイヤー制約**: 特定プレイヤー同士の組み合わせ制限検証
4. **長期運用**: 100ラウンド以上での統計安定性検証
5. **メモリ効率**: 大規模データでのメモリ使用量測定